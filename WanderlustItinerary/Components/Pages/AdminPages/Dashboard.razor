@page "/admin/dashboard"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using WanderlustItinerary.Domain
@inject IDbContextFactory<WanderlustItinerary.Data.WanderlustItineraryContext> DbFactory

@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Admin Dashboard</PageTitle>

<div class="min-h-screen bg-slate-50 dark:bg-[#101922] px-4 py-6">
    <div class="max-w-6xl mx-auto">

        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Admin</p>
                <h1 class="text-slate-900 dark:text-white text-2xl font-bold tracking-tight">Dashboard</h1>
            </div>
        </div>

        @if (loading)
        {
            <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#192633] p-5 shadow-sm">
                <p class="text-slate-500 dark:text-slate-400">Loading...</p>
            </div>
        }
        else
        {
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#192633] p-5 shadow-sm">
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Total Bookings</p>
                    <p class="text-slate-900 dark:text-white text-3xl font-bold mt-2">@TotalBookings</p>
                </div>

                <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#192633] p-5 shadow-sm">
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Upcoming Bookings</p>
                    <p class="text-slate-900 dark:text-white text-3xl font-bold mt-2">@UpcomingBookings</p>
                </div>

                <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#192633] p-5 shadow-sm">
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Pending</p>
                    <p class="text-slate-900 dark:text-white text-3xl font-bold mt-2">@PendingBookings</p>
                </div>

                <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#192633] p-5 shadow-sm">
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Confirmed</p>
                    <p class="text-slate-900 dark:text-white text-3xl font-bold mt-2">@ConfirmedBookings</p>
                </div>
            </div>

            <!-- Recent Bookings -->
            <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#192633] shadow-sm mb-6 overflow-hidden">
                <div class="px-5 py-4 flex items-center justify-between border-b border-slate-200 dark:border-slate-700">
                    <h2 class="text-slate-900 dark:text-white font-bold">Recent Bookings</h2>
                </div>

                @if (RecentBookings.Count == 0)
                {
                    <div class="p-5">
                        <p class="text-slate-500 dark:text-slate-400">No bookings yet.</p>
                    </div>
                }
                else
                {
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-slate-50 dark:bg-[#1a2634]">
                                <tr class="text-left text-slate-500 dark:text-slate-400">
                                    <th class="px-5 py-3 font-semibold">Package</th>
                                    <th class="px-5 py-3 font-semibold">Date</th>
                                    <th class="px-5 py-3 font-semibold">NumPax</th>
                                    <th class="px-5 py-3 font-semibold">Status</th>
                                    <th class="px-5 py-3 font-semibold">UserId</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                @foreach (var b in RecentBookings)
                                {
                                    <tr class="text-slate-900 dark:text-white">
                                        <td class="px-5 py-3 font-medium">@b.PackageName</td>
                                        <td class="px-5 py-3 text-slate-600 dark:text-slate-300">@b.Date.ToString("dd/MM/yyyy hh:mm tt")</td>
                                        <td class="px-5 py-3">@b.NumPax</td>

                                        <td class="px-5 py-3">
                                            @{
                                                var s = (b.Status ?? "").ToLower();
                                                var badgeClass =
                                                s == "confirmed" ? "bg-green-500/10 text-green-400 border-green-500/20" :
                                                s == "pending" ? "bg-orange-500/10 text-orange-400 border-orange-500/20" :
                                                "bg-slate-500/10 text-slate-300 border-slate-500/20";
                                            }
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full border text-xs font-bold @badgeClass">
                                                @b.Status
                                            </span>
                                        </td>

                                        <td class="px-5 py-3 text-slate-600 dark:text-slate-300">
                                            <span class="inline-block max-w-[260px] truncate align-middle" title="@b.UserId">@b.UserId</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>

            <!-- Top Packages -->
            <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#192633] shadow-sm overflow-hidden">
                <div class="px-5 py-4 flex items-center justify-between border-b border-slate-200 dark:border-slate-700">
                    <h2 class="text-slate-900 dark:text-white font-bold">Top Booked Packages</h2>
                </div>

                @if (TopPackages.Count == 0)
                {
                    <div class="p-5">
                        <p class="text-slate-500 dark:text-slate-400">No data yet.</p>
                    </div>
                }
                else
                {
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-slate-50 dark:bg-[#1a2634]">
                                <tr class="text-left text-slate-500 dark:text-slate-400">
                                    <th class="px-5 py-3 font-semibold">Package</th>
                                    <th class="px-5 py-3 font-semibold">Bookings</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                @foreach (var p in TopPackages)
                                {
                                    <tr class="text-slate-900 dark:text-white">
                                        <td class="px-5 py-3 font-medium">@p.PackageName</td>
                                        <td class="px-5 py-3">
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full border text-xs font-bold bg-blue-500/10 text-blue-400 border-blue-500/20">
                                                @p.Count
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }
    </div>
</div>


@code {
    private bool loading = true;

    private int TotalBookings;
    private int UpcomingBookings;
    private int PendingBookings;
    private int ConfirmedBookings;

    private List<RecentBookingRow> RecentBookings = new();
    private List<TopPackageRow> TopPackages = new();

    protected override async Task OnInitializedAsync()
    {
        loading = true;

        using var context = DbFactory.CreateDbContext();

        TotalBookings = await context.Booking.CountAsync();

        UpcomingBookings = await context.Booking
            .CountAsync(b => b.Date >= DateTime.Now);

        PendingBookings = await context.Booking
            .CountAsync(b => b.Status.ToLower() == "pending");

        ConfirmedBookings = await context.Booking
            .CountAsync(b => b.Status.ToLower() == "confirmed");

        // Recent bookings with PackageName (manual join)
        RecentBookings = await (
            from b in context.Booking
            join p in context.Package on b.PackageId equals p.Id
            orderby b.DateCreated descending
            select new RecentBookingRow(
                p.PackageName,
                b.Date,
                b.NumPax,
                b.Status,
                b.UserId
            )
        ).Take(8).ToListAsync();

        // Top packages by booking count
        TopPackages = await (
            from b in context.Booking
            join p in context.Package on b.PackageId equals p.Id
            group b by p.PackageName into g
            orderby g.Count() descending
            select new TopPackageRow(g.Key, g.Count())
        ).Take(5).ToListAsync();

        loading = false;
    }

    private record RecentBookingRow(string PackageName, DateTime Date, int NumPax, string Status, string? UserId);
    private record TopPackageRow(string PackageName, int Count);
}
